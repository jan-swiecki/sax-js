#!/bin/bash
set -eo pipefail

rm -rf dist

# --external:tap \
# --external:lodash \
# --bundle \
esbuild \
  --log-level=warning \
  --keep-names \
  --tsconfig=tsconfig.json \
  --platform=node \
  --outdir=dist \
  lib/sax.ts test/*.ts
  # --out-extension:.js=.mjs \

for x in lib test; do
  if [ -d "$x" ]; then
    mkdir -p dist/$x
    rsync -aur --exclude="*.ts" ./$x/ dist/$x
  elif [[ -f "$x" && ! "$x" =~ \.ts$ ]]; then
    cp "$x" dist/$x
  fi
done

cp package.json dist

tsc --esModuleInterop --lib es2020 --declaration --emitDeclarationOnly --outDir dist/lib lib/sax.ts